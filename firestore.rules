rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Reglas para productos
    match /productos/{productoId} {
      // Cualquier usuario autenticado puede leer productos activos
      allow read: if request.auth != null && resource.data.activo == true;

      // Cualquier usuario autenticado puede crear y actualizar productos
      allow create, update: if request.auth != null
        && request.resource.data.keys().hasAll(['nombre', 'precio', 'activo'])
        && request.resource.data.precio is number
        && request.resource.data.precio >= 0;

      // Solo se puede hacer soft delete (marcar como inactivo)
      allow update: if request.auth != null
        && request.resource.data.activo == false;
    }

    // Reglas para miembros
    match /miembros/{miembroId} {
      // Cualquier usuario autenticado puede leer miembros activos
      allow read: if request.auth != null && resource.data.activo == true;

      // Cualquier usuario autenticado puede crear y actualizar miembros
      allow create, update: if request.auth != null
        && request.resource.data.keys().hasAll(['nombre', 'activo'])
        && request.resource.data.nombre is string
        && request.resource.data.nombre.size() > 0;

      // Solo se puede hacer soft delete (marcar como inactivo)
      allow update: if request.auth != null
        && request.resource.data.activo == false;
    }

    // Reglas para ventas
    match /ventas/{ventaId} {
      // Cualquier usuario autenticado puede leer todas las ventas
      allow read: if request.auth != null;

      // Cualquier usuario autenticado puede crear ventas
      allow create: if request.auth != null
        && request.resource.data.keys().hasAll([
          'productoId', 'productoNombre',
          'miembroId', 'miembroNombre',
          'cantidad', 'precioUnitario', 'total', 'fecha'
        ])
        && request.resource.data.cantidad is int
        && request.resource.data.cantidad > 0
        && request.resource.data.precioUnitario is number
        && request.resource.data.precioUnitario >= 0
        && request.resource.data.total == request.resource.data.cantidad * request.resource.data.precioUnitario;

      // Cualquier usuario autenticado puede eliminar ventas
      allow delete: if request.auth != null;
    }
  }
}
